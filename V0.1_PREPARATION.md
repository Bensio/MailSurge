# MailSurge v0.1.0 - Preparation Guide

**Release Target:** v0.1.0  
**Date:** $(date)

---

## üéØ Pre-Release Checklist

### ‚úÖ Database Migrations (CRITICAL)

You have **6 migrations** that must be run in order. Based on your Supabase SQL Editor tabs, here's the execution plan:

---

## üìã Migration Execution Order

### **Migration 001: Initial Schema** ‚úÖ
**File:** `supabase/migrations/001_initial_schema.sql`  
**Tab:** "SQL Email Campaigns, Contacts & Templates Schema"

**What it does:**
- Creates `campaigns`, `contacts`, and `templates` tables
- Sets up Row Level Security (RLS) policies
- Creates indexes

**Verification Query:**
```sql
-- Check if tables exist
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('campaigns', 'contacts', 'templates');
-- Should return 3 rows
```

**Status:** [ ] Not Run / [ ] Running / [ ] Verified

---

### **Migration 002: Contacts Library** ‚úÖ
**File:** `supabase/migrations/002_add_contacts_library.sql`  
**Tab:** "SQL Contacts: user library and campaign support"

**What it does:**
- Adds `user_id` and `name` columns to contacts
- Makes `campaign_id` nullable (for library contacts)
- Updates RLS policies for library support
- Creates new unique constraints

**Verification Query:**
```sql
-- Check if user_id column exists
SELECT column_name, data_type, is_nullable
FROM information_schema.columns 
WHERE table_name = 'contacts' 
AND column_name = 'user_id';
-- Should return: user_id | uuid | YES
```

**Status:** [ ] Not Run / [ ] Running / [ ] Verified

---

### **Migration 003: From Email** ‚úÖ
**File:** `supabase/migrations/003_add_from_email.sql`  
**Tab:** "SQL Add from_email to campaigns"

**What it does:**
- Adds `from_email` column to campaigns table
- Allows users to select which Gmail account to send from

**Verification Query:**
```sql
-- Check if from_email column exists
SELECT column_name, data_type, is_nullable
FROM information_schema.columns 
WHERE table_name = 'campaigns' 
AND column_name = 'from_email';
-- Should return: from_email | text | YES
```

**Status:** [ ] Not Run / [ ] Running / [ ] Verified

---

### **Migration 004: Archived Status** ‚ö†Ô∏è
**File:** `supabase/migrations/004_add_archived_status.sql`  
**Tab:** (May not be open - check if needed)

**What it does:**
- Adds 'archived' status to campaigns
- Updates status constraint to include archived

**Verification Query:**
```sql
-- Check if archived status is allowed
SELECT constraint_name, check_clause
FROM information_schema.check_constraints
WHERE constraint_name = 'campaigns_status_check';
-- Should include 'archived' in the check clause
```

**Status:** [ ] Not Run / [ ] Running / [ ] Verified

---

### **Migration 005: Remove Duplicates** (Optional)
**File:** `supabase/migrations/005_remove_duplicate_library_contacts.sql`  
**Tab:** "SQL Remove duplicate library contacts"

**What it does:**
- Removes duplicate library contacts
- Keeps only the first occurrence per email/user

**‚ö†Ô∏è IMPORTANT:** Only run this if you have existing duplicate contacts!

**Verification Query:**
```sql
-- Check for duplicates BEFORE running
SELECT user_id, LOWER(email) as email_lower, COUNT(*) as count
FROM contacts
WHERE campaign_id IS NULL
GROUP BY user_id, LOWER(email)
HAVING COUNT(*) > 1;
-- If this returns rows, you have duplicates
```

**Status:** [ ] Not Needed / [ ] Running / [ ] Verified

---

### **Migration 006: Design JSON** üî¥ CRITICAL
**File:** `supabase/migrations/006_add_design_json.sql`  
**Tab:** "SQL Campaigns design_json for Unlayer editor" (Currently open)

**What it does:**
- Adds `design_json` JSONB column to campaigns
- Creates GIN index for JSONB queries
- Required for campaign editing functionality

**Verification Query:**
```sql
-- Check if design_json column exists
SELECT column_name, data_type
FROM information_schema.columns 
WHERE table_name = 'campaigns' 
AND column_name = 'design_json';
-- Should return: design_json | jsonb

-- Check if index exists
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'campaigns' 
AND indexname = 'idx_campaigns_design_json';
-- Should return the GIN index
```

**Status:** [ ] Not Run / [ ] Running / [ ] Verified

---

## üöÄ Execution Steps

### Step 1: Verify Current State

Run this comprehensive check to see what's already applied:

```sql
-- Complete migration status check
SELECT 
  '001_initial_schema' as migration,
  CASE 
    WHEN EXISTS (
      SELECT 1 FROM information_schema.tables 
      WHERE table_name = 'campaigns'
    ) THEN '‚úÖ Applied'
    ELSE '‚ùå Not Applied'
  END as status
UNION ALL
SELECT 
  '002_contacts_library',
  CASE 
    WHEN EXISTS (
      SELECT 1 FROM information_schema.columns 
      WHERE table_name = 'contacts' AND column_name = 'user_id'
    ) THEN '‚úÖ Applied'
    ELSE '‚ùå Not Applied'
  END
UNION ALL
SELECT 
  '003_from_email',
  CASE 
    WHEN EXISTS (
      SELECT 1 FROM information_schema.columns 
      WHERE table_name = 'campaigns' AND column_name = 'from_email'
    ) THEN '‚úÖ Applied'
    ELSE '‚ùå Not Applied'
  END
UNION ALL
SELECT 
  '004_archived_status',
  CASE 
    WHEN EXISTS (
      SELECT 1 FROM information_schema.check_constraints
      WHERE constraint_name = 'campaigns_status_check'
      AND check_clause LIKE '%archived%'
    ) THEN '‚úÖ Applied'
    ELSE '‚ùå Not Applied'
  END
UNION ALL
SELECT 
  '006_design_json',
  CASE 
    WHEN EXISTS (
      SELECT 1 FROM information_schema.columns 
      WHERE table_name = 'campaigns' AND column_name = 'design_json'
    ) THEN '‚úÖ Applied'
    ELSE '‚ùå Not Applied'
  END;
```

### Step 2: Execute Migrations in Order

**For each migration:**

1. **Open the migration file** in your SQL Editor tab
2. **Copy the entire contents**
3. **Paste into Supabase SQL Editor**
4. **Click "Run"** (or Ctrl+Enter)
5. **Verify success** (should see "Success. No rows returned" or similar)
6. **Run verification query** (from above)
7. **Check the box** ‚úÖ in this document

### Step 3: Handle Migration 004

If you don't have Migration 004 open in a tab:

1. Go to Supabase Dashboard ‚Üí SQL Editor
2. Click "New Query"
3. Open `supabase/migrations/004_add_archived_status.sql` in your editor
4. Copy and paste into Supabase
5. Run it

### Step 4: Optional Migration 005

**Only run if:**
- You have existing contacts in your database
- You want to clean up duplicates

**Before running:**
- Check for duplicates using the verification query above
- If no duplicates, skip this migration

---

## ‚úÖ Post-Migration Verification

After running all migrations, verify everything:

```sql
-- Complete schema verification
SELECT 
  'Tables' as check_type,
  COUNT(*) as count,
  string_agg(table_name, ', ') as details
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('campaigns', 'contacts', 'templates')

UNION ALL

SELECT 
  'Campaign Columns',
  COUNT(*),
  string_agg(column_name, ', ')
FROM information_schema.columns 
WHERE table_name = 'campaigns'
AND column_name IN ('from_email', 'design_json', 'status')

UNION ALL

SELECT 
  'Contact Columns',
  COUNT(*),
  string_agg(column_name, ', ')
FROM information_schema.columns 
WHERE table_name = 'contacts'
AND column_name IN ('user_id', 'name', 'campaign_id')

UNION ALL

SELECT 
  'RLS Policies',
  COUNT(*),
  string_agg(policyname, ', ')
FROM pg_policies
WHERE schemaname = 'public'
AND tablename IN ('campaigns', 'contacts', 'templates');
```

**Expected Results:**
- Tables: 3 (campaigns, contacts, templates)
- Campaign Columns: 3 (from_email, design_json, status)
- Contact Columns: 3 (user_id, name, campaign_id)
- RLS Policies: 12+ (4 per table)

---

## üîç Troubleshooting

### Migration Fails with "Already Exists"
- This is OK! The migrations use `IF NOT EXISTS`
- Check verification query to confirm it's applied

### Migration Fails with "Column Already Exists"
- The column already exists from a previous run
- Skip to next migration

### Migration 004 Fails
- Check if constraint name is different
- May need to drop existing constraint first
- The migration handles this with `DROP CONSTRAINT IF EXISTS`

### Migration 006 Missing
- **CRITICAL:** This is required for campaign editing
- Without it, campaigns cannot be edited after creation
- Must be applied before v0.1 release

---

## üìù Pre-Release Checklist

### Database
- [ ] Migration 001 applied and verified
- [ ] Migration 002 applied and verified
- [ ] Migration 003 applied and verified
- [ ] Migration 004 applied and verified
- [ ] Migration 005 applied (if needed) or skipped
- [ ] Migration 006 applied and verified
- [ ] All verification queries pass
- [ ] RLS policies active

### Code
- [ ] All tests pass (if any)
- [ ] Build succeeds: `npm run build`
- [ ] No TypeScript errors
- [ ] No linting errors

### Environment
- [ ] `.env.example` file exists
- [ ] All required env vars documented
- [ ] Production env vars set in Vercel

### Documentation
- [ ] README.md updated
- [ ] Migration order documented
- [ ] Setup instructions clear

### Git
- [ ] All changes committed
- [ ] Version tag ready: `v0.1.0`
- [ ] Release notes prepared

---

## üéØ Quick Reference

### Migration Order (Required)
1. ‚úÖ `001_initial_schema.sql`
2. ‚úÖ `002_add_contacts_library.sql`
3. ‚úÖ `003_add_from_email.sql`
4. ‚úÖ `004_add_archived_status.sql`
5. ‚ö†Ô∏è `005_remove_duplicate_library_contacts.sql` (optional)
6. üî¥ `006_add_design_json.sql` (CRITICAL)

### Your SQL Editor Tabs
Based on your open tabs:
1. ‚úÖ "SQL Campaigns design_json for Unlayer editor" ‚Üí Migration 006
2. ‚úÖ "SQL Email Campaigns, Contacts & Templates Schema" ‚Üí Migration 001
3. ‚úÖ "SQL Contacts: user library and campaign support" ‚Üí Migration 002
4. ‚úÖ "SQL Add from_email to campaigns" ‚Üí Migration 003
5. ‚úÖ "SQL Remove duplicate library contacts" ‚Üí Migration 005
6. ‚ö†Ô∏è "SQL Missing migration contents" ‚Üí Check what this is
7. ‚ùì Migration 004 tab - May need to open manually

---

## üö® Critical Notes

1. **Migration 006 is REQUIRED** - Without it, campaign editing won't work
2. **Migration 004 must be run** - Adds archived status support
3. **Migration 005 is optional** - Only if you have duplicates
4. **Run in order** - Dependencies exist between migrations
5. **Verify after each** - Don't skip verification queries

---

## ‚úÖ Ready for v0.1.0?

Once all migrations are applied and verified:
- [ ] All 6 migrations executed
- [ ] All verification queries pass
- [ ] No errors in Supabase logs
- [ ] Test campaign creation/editing works
- [ ] Test contact library works

**Then you're ready to tag and release v0.1.0!** üéâ

---

**Last Updated:** $(date)  
**Next Review:** After migrations complete

